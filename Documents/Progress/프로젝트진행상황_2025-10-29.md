# 🎯 더문 프로젝트 진행 상황 (2025-10-29)

## 📊 현재 상태 한눈에 보기

| 영역 | 상태 | 상세 |
|------|------|------|
| **계획** | ✅ 완료 | 마스터플랜 v2.1 + Phase 2-5 상세 가이드 작성 완료 |
| **DB 진단** | ✅ 완료 | 실제 DB 검증 (13 beans, 7 blends, 14 recipes, 60 transactions) |
| **Phase 2-5 가이드** | ✅ 완료 | T2-1 ~ T2-9, T3-1 ~ T3-11, T4, T5 상세 구현 방법 작성 |
| **준비도** | 🟡 진행 중 | Phase 1 실행 대기 중 |

---

## 📈 프로젝트 준비도 평가

### A. 문서 완성도 (100%)

```
✅ 마스터플랜 v2.1
   - 로스팅 전략 + 웹 구현 통합
   - 원가 계산 공식 확정
   - 블렌드 구조 명확화 (혼합률% 기반)

✅ Phase 1 상세 가이드
   - 10일 실행 계획
   - Excel 마이그레이션 스크립트
   - 데이터 검증 체크리스트

✅ Phase 2-5 통합 구현 가이드 (오늘 작성)
   - T2-1: DB 스키마 (6개 새 테이블)
   - T2-2: 6개 새 SQLAlchemy 모델
   - T2-3 ~ T2-7: 5개 서비스 완전 구현 코드
   - T2-8: Unit Test 전략
   - T2-9: 코드 리뷰 체크리스트
   - T3-1 ~ T3-11: 11개 페이지 개요
   - T4-T5: 테스트 및 배포 계획
```

### B. 기술 준비도 (70%)

```
✅ 기존 코드 상태
   - Bean, Blend, BlendRecipe, Inventory, Transaction 모델 존재
   - 5개 기본 서비스 존재 (bean, blend, excel, analytics, report)
   - SQLite DB + SQLAlchemy ORM 기반 구조
   - Streamlit 멀티페이지 앱 기반

⚠️ 필요한 추가
   - RoastingLog 모델 (Phase 1에서 추가)
   - BlendRecipesHistory, User, Permission, AuditLog, LossRateWarning (Phase 2)
   - 5개 새 서비스 (RoastingService, CostService, AuthService 등)
   - 대부분의 페이지 구현/수정
```

### C. 데이터 준비도 (65%)

```
✅ 현재 데이터 상태
   - Beans (13개): 마사이, 안티구아, 모모라, g4, 예가체프, 코케허니 등
   - Blends (7개): 풀문, 뉴문 + 개별 원두 entries
   - Cost Settings (7개): 기존 코드에 있음 (용도 파악 필요)
   - Transactions (60개): test_data.py로 생성된 테스트 데이터

⚠️ 문제점
   - Beans: price_per_kg이 모두 0.0 (Phase 1 T1-4에서 입력 필요)
   - Blends: 구조 이상 ("마사이", "안티구아" 같은 개별 원두가 blend으로 등록)
   - Recipe: portion_count와 ratio가 혼재 (명확화 필요)
   - RoastingLog: 완전히 없음 (Phase 1에서 추가)
```

---

## 🗓️ 실행 계획

### Phase 1 (1.5주) - 데이터 기초 구축
**상태:** 📋 계획 완료, 🚀 실행 대기

```
목표: Excel 로스팅 데이터 마이그레이션 + 데이터 정리
┌─────────────────────────────────────┐
│ T1-1: 마이그레이션 (3일)            │ ← 가장 복잡
│ T1-2: 원두 설정 (1일)               │
│ T1-3: 블렌드 설정 (1.5일)           │
│ T1-4: 원가 입력 (1일)               │
│ T1-5: 데이터 검증 (1일)             │
│ T1-6: 손실률 설정 (1day)            │
└─────────────────────────────────────┘
산출물: 정제된 DB + RoastingLog 테이블
```

**지난 진행:**
- ✅ Phase 1 마스터플랜 & 상세 가이드 작성 완료
- ✅ ExcelSyncService.migrate_roasting_logs() 코드 완성
- ✅ 데이터 검증 스크립트 작성
- ⏳ 실제 로스팅 데이터 (분석결과.xlsx) 확인 필요

### Phase 2 (2.5주) - 백엔드 서비스
**상태:** 📋 가이드 완료, 🚀 실행 대기

```
목표: DB 스키마 완성 + 5개 추가 서비스 구현
┌────────────────────────────────────────┐
│ T2-1: DB 스키마 (1일)                 │
│ T2-2: SQLAlchemy 모델 (1.5일)        │
│ T2-3: RoastingService (1.5일)        │
│ T2-4: CostService (1.5일)             │ ← 핵심 비즈니스 로직
│ T2-5: AuthService (1일)               │
│ T2-6: LossRateAnalyzer (1일)          │
│ T2-7: ExcelSyncService (1.5일)       │
│ T2-8: Unit Tests (2일)                │
│ T2-9: 코드 리뷰 (0.5일)              │
└────────────────────────────────────────┘
산출물: 프로덕션 레디 백엔드 API
```

**가이드 위치:**
→ `Documents/Implementation/Phase2-5_통합구현가이드.md`

### Phase 3 (3주) - 프론트엔드
**상태:** 📋 개요 완료, 📝 상세가이드 필요

```
11개 페이지 구현:
- T3-1: 로그인
- T3-2: 대시보드
- T3-3 ~ T3-6: 핵심 기능 (원두, 블렌드, 로스팅, 그리드)
- T3-7 ~ T3-11: 추가 기능 (원가, 분석, 거래, 보고서, 권한)
```

### Phase 4 (2주) - 테스트
테스트 커버리지 90% 이상

### Phase 5 (1.5주) - 배포
프로덕션 환경 구성 및 배포 자동화

---

## 🚀 이제부터 할 일

### 1단계: Phase 1 실행 (이번 주)

**체크리스트:**
```
□ 분석결과.xlsx 파일 확인
  위치: ./Documents/Resources/로스팅일지_분석결과.xlsx

□ Excel 마이그레이션 스크립트 실행
  - T1-1 가이드의 migrate_roasting_logs() 함수 실행
  - 데이터 검증 완료

□ 데이터 정리
  - Blends 테이블 구조 수정 (개별 원두 제거)
  - Beans price_per_kg 입력
  - BlendRecipe 필드 명확화

□ RoastingLog 테이블 생성 + 데이터 마이그레이션
```

**예상 일정:**
- T1-1: 월~수 (3일) - 마이그레이션
- T1-2~6: 목~금 + 월 (5일) - 데이터 정리
- **총 1.5주**

### 2단계: Phase 2 실행 (다음 주부터)

**체크리스트:**
```
□ T2-1: DB 스키마 (1일)
  - 6개 새 테이블 SQL 작성 및 실행
  - 기존 테이블 수정 (blend_recipes)

□ T2-2: SQLAlchemy 모델 (1.5일)
  - 6개 새 모델 클래스 정의
  - 기존 모델 관계(relationship) 설정

□ T2-3 ~ T2-7: 서비스 개발 (6.5일)
  - Phase2-5 가이드의 완전한 코드 구현
  - 에러 핸들링 + 로깅 추가

□ T2-8: Unit Tests (2일)
  - pytest 테스트 작성 및 실행
  - 90% 커버리지 달성

□ T2-9: 코드 리뷰 (0.5일)
  - 문서화, 타입 힌트, 최적화
```

**예상 일정:** 2.5주 (10일 작업 + buffer)

### 3단계: Phase 3 시작 준비 (동시 진행)

```
현재 필요한 것:
□ Phase 3 페이지별 상세 구현 가이드 작성
  - 각 페이지의 UI/UX 설계
  - 필요한 API 엔드포인트 명시
  - Streamlit 컴포넌트 재사용 계획
```

---

## 📋 주요 결정사항 정리

### 1. 블렌드 구조 (혼합률% 기반)

**정의:**
```
Full Moon: 마사이 40% + 안티구아 40% + 모모라 10% + g4 10% = 100%
New Moon: 브라질 60% + 콜롬비아 30% + g4 10% = 100%
```

**원가 계산 공식:**
```
최종 원가 = (마사이가격×0.4 + 안티구아가격×0.4 + 모모라가격×0.1 + g4가격×0.1) / (1-0.17)
        = 혼합 원가 / 0.83
```

### 2. 손실률 (17% 고정)

- 블렌딩 후 로스팅 시 생두 대비 17% 감량
- 각 원두별이 아닌 **혼합 후 전체에 대한 손실률**
- RoastingLog에서 자동 계산 및 편차 추적

### 3. 데이터 구조 확정

```
beans (13)
├─ price_per_kg (입력 필요)
├─ country_code, country_name
└─ roast_level (W/N/D)

blends (2개 핵심: 풀문, 뉴문)
├─ loss_rate_percent (17.0)
├─ standard_selling_price (22,000 for 풀문)
└─ recipes (1:N)

blend_recipes (혼합률% 기반)
├─ blending_ratio_percent (0-100, 합=100%)
├─ version, effective_date (버전 관리)
└─ is_current (현재 활성 레시피?)

roasting_logs (새로 추가)
├─ raw_weight_kg, roasted_weight_kg
├─ loss_rate_percent (자동 계산)
├─ loss_variance_percent (예상 vs 실제)
└─ roasting_date, roasting_month
```

---

## 🔍 현재 코드 상태 분석

### 기존 파일 (수정 필요)

```
app/models/database.py (수정 필요)
├─ Blend: total_portion → 제거 (혼합률% 기반으로 변경)
├─ BlendRecipe: portion_count 제거, ratio → blending_ratio_percent
├─ Bean: price_per_kg (이미 있음, 값만 입력 필요)
└─ 새 모델 추가: RoastingLog, BlendRecipesHistory, User 등

app/services/blend_service.py (수정 필요)
├─ 포션 기반 로직 → 혼합률(%) 기반으로 변경
└─ 비용 계산 로직 분리 (CostService로 이동)

app/services/excel_service.py (확장 필요)
├─ migrate_roasting_logs() 함수 추가
├─ 마이그레이션 검증 로직 추가
└─ Excel 내보내기 기능 추가
```

### 새로 작성할 파일

```
app/services/roasting_service.py (새로 작성)
├─ create_roasting_log()
├─ get_roasting_logs_by_month()
├─ get_monthly_statistics()
└─ _check_loss_rate_anomaly()

app/services/cost_service.py (새로 작성)
├─ get_blend_cost() ← 핵심 비즈니스 로직
├─ update_bean_price()
└─ batch_calculate_all_blends()

app/services/auth_service.py (새로 작성)
├─ create_user()
├─ authenticate()
├─ grant_permission()
└─ has_permission()

app/services/loss_rate_analyzer.py (새로 작성)
├─ analyze_loss_rate_trend()
├─ get_recent_warnings()
└─ resolve_warning()
```

---

## ⚠️ 잠재적 위험 요소

### 1. 데이터 마이그레이션 (Phase 1)
- **위험:** Excel 데이터 형식 오류, 누락된 필드
- **대응:** T1-1의 검증 로직 + 롤백 전략 준비

### 2. 기존 코드 호환성 (Phase 2)
- **위험:** 기존 서비스가 portion_count에 의존
- **대응:** 모든 참조 코드 사전 검토 및 수정

### 3. UI/UX 복잡도 (Phase 3)
- **위험:** 11개 페이지, 권한 기반 접근 제어 필요
- **대응:** 이른 프로토타입 테스트, 컴포넌트 재사용 극대화

### 4. 테스트 커버리지 (Phase 4)
- **위험:** 90% 커버리지 달성 어려움
- **대응:** 핵심 로직(CostService, RoastingService)부터 집중

---

## 📊 완료된 산출물

| 문서 | 위치 | 용도 |
|------|------|------|
| **마스터플랜 v2.1** | `Documents/Planning/` | 프로젝트 전체 로드맵 |
| **로스팅_플랜_2025.md** | `Documents/Planning/` | 로스팅 전략 & 원두/블렌드 정의 |
| **Phase1_상세가이드** | `Documents/Implementation/` | 10일 실행 계획 + 마이그레이션 코드 |
| **Phase2-5_가이드** | `Documents/Implementation/` | ✨ **오늘 작성** - 모든 구현 상세 코드 |
| **ProjectStatusReport** | `Documents/` | 현재 상태 진단 |
| **이 문서** | `Documents/Progress/` | 전체 진행 상황 요약 |

---

## 🎯 다음 세션 준비

### 체크 사항
1. ✅ Phase 2-5 가이드 문서 검토
2. ⏳ 분석결과.xlsx 파일 위치 확인
3. ⏳ Phase 1 시작 전 OK 신호 대기

### 예상 다음 작업
```
1. Phase 1 실행 (T1-1 마이그레이션 스크립트)
2. Phase 2 T2-1 (DB 스키마 생성)
3. Phase 2 T2-2 (SQLAlchemy 모델 작성)
```

---

## 📌 중요 파일 위치

```
프로젝트 root: /mnt/d/Ai/WslProject/TheMoon_Project/

📂 Documents/
├─ Planning/
│  ├─ 마스터플랜_v2.1.md (메인 플랜)
│  ├─ 로스팅_플랜_2025.md (로스팅 전략)
│  └─ 마스터플랜_전문가_검토_및_개선안.md (검토)
├─ Implementation/
│  ├─ Phase1_데이터기초구축_상세가이드.md
│  └─ Phase2-5_통합구현가이드.md ← 오늘 작성
├─ Progress/
│  ├─ SESSION_START_CHECKLIST.md
│  ├─ SESSION_END_CHECKLIST.md
│  ├─ ProjectStatusReport_2025-10-29.md
│  └─ 이 파일
└─ Resources/
   └─ 로스팅일지_분석결과.xlsx

📂 Data/
└─ roasting_data.db (SQLite 데이터베이스)

📂 app/
├─ models/database.py (수정 필요)
├─ services/ (확장/수정 필요)
└─ pages/ (대부분 수정 필요)
```

---

## ✅ 최종 체크리스트

```
[✅] 마스터플랜 v2.1 완성
[✅] Phase 1 상세 가이드 완성
[✅] Phase 2-5 통합 구현 가이드 완성
[✅] DB 상태 진단 (13 beans, 7 blends 확인)
[✅] 프로젝트 준비도 평가 (70%)
[⏳] Phase 1 실행 (다음 주)
[⏳] Phase 2 실행 (그 다음주부터)
[⏳] Phase 3-5 실행 (순차적)
```

---

**문서 작성:** 2025-10-29 23:30 KST
**기반:** 실제 프로젝트 진단 + DB 검증 결과
**다음 갱신:** Phase 1 완료 후 (약 1.5주)

---

## 🎓 학습사항 정리

이 프로젝트를 통해 배운 것:

1. **비즈니스 로직의 중요성**
   - 포션(portion count) vs 혼합률(blending ratio %)의 차이
   - 손실률을 개별이 아닌 혼합 후 전체로 관리

2. **데이터 마이그레이션 복잡성**
   - Excel → DB 마이그레이션은 단순 복사가 아님
   - 검증, 에러 처리, 롤백 전략이 필수

3. **단계별 구현의 중요성**
   - Phase 1 (데이터): Phase 2-5의 기초
   - 부실한 데이터 = 나머지 모든 작업 영향

4. **설계의 가치**
   - 코드 작성 전 설계가 매우 중요
   - 이 프로젝트: 3주 기획 → 9주 구현 구조 확립
